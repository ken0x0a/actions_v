name: '[reusable] Compat check'

on:
  workflow_call:
    inputs:
      REPO_DIR:
        required: true
        type: string

jobs:
  compat-check:
    # As this action is for checking V. compatibility,
    # no need to run further jobs if V repo doesn't changed.
    needs: [check-hash]
    # if: needs.check-hash.steps.is-last-hash.outputs.cache-hit != 'true'
    if: needs.check-hash.outputs.cache-hit != 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: \[pre] V (checkout)
        uses: actions/checkout@v2
        with:
          repository: vlang/v
          path: v
      - name: \[pre] V (build)
          # make -j$(sysctl -n hw.logicalcpu)
        run: |
          make -j$(nproc)
          sudo ./v symlink
        working-directory: ./v

      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: ${{ inputs.REPO_DIR }}

      - name: Run
        run: v run main.v
        working-directory: ${{ inputs.REPO_DIR }}
      # - name: Build
      #   run: v -o derive bin/derive
      #   working-directory: ${{ inputs.REPO_DIR }}
      # - name: Test
      #   run: v test examples/simple
      #   working-directory: ${{ inputs.REPO_DIR }}
